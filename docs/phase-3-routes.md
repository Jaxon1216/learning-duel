# Phase 3：学习路线模块

## 目标

让用户能创建多条学习路线（如"前端"、"英语"），在每条路线下添加学习节点，标记完成状态，看到进度。

## 核心组件

### RouteTabs — 路线切换

显示为一排"胶囊按钮"（pill tabs）。每个路线一个 tab，点击切换。

- 选中的 tab 是黑底白字
- 自己的路线可以新增和删除
- 看别人的路线时不显示操作按钮

### NodeTimeline — 节点时间轴

竖向排列的学习节点，类似地铁线路图：

- 左侧是圆点 + 连线
- 已完成的节点：绿色圆点 + 绿色连线 + 标题划线
- 未完成的节点：空心圆点 + 灰色连线
- 点击圆点切换完成状态（仅自己的）
- 每个节点显示：序号、标题、标签（可选）、截止日期倒计时（可选）

### AddNodeForm — 添加节点

表单包含：
- 标题（必填）
- 标签（选填，如"基础"、"进阶"）
- 截止日期（选填，自动计算倒计时）

### 完成率计算

```
完成率 = 已完成节点数 / 总节点数 × 100
```

精确到小数点两位（如 66.67%）。显示在时间轴顶部。

## 数据流

```
用户 → 选择路线 Tab → 加载该路线的 route_nodes → 渲染时间轴
                    → 点击节点 → update completed → 重新加载
                    → 添加节点 → insert route_nodes → 重新加载
```

## 数据结构配合

- `routes.user_id` = 当前用户，自动由 `DEFAULT auth.uid()` 填入
- `route_nodes.route_id` 关联路线
- `order_index` 控制显示顺序，新增时取当前最大值 + 1
- `completed` 布尔值控制颜色

## 权限保证

- INSERT routes：`auth.uid() = user_id`（只能创建自己的路线）
- INSERT route_nodes：检查 route_id 对应的路线是否属于自己
- UPDATE route_nodes：同上（切换完成状态）
- DELETE：同上

看别人的路线时，前端隐藏所有操作按钮（`isOwner` 判断），即使用户修改前端代码尝试操作，RLS 也会拦住。

## 验收标准

- [x] 能创建新路线（显示为新 tab）
- [x] 能删除路线（节点自动删除，CASCADE）
- [x] 能添加节点（标题、标签、截止日期）
- [x] 节点按 order_index 排序
- [x] 点击节点能切换完成状态（绿色/灰色）
- [x] 完成率显示且精确到两位小数
- [x] 截止日期显示倒计时
